name: C++ CI

permissions:
  contents: read

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

defaults:
  run:
    working-directory: cpp

jobs:
  build:
    name: ${{ matrix.os }} - C++${{ matrix.cxx_standard }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        cxx_standard: [11, 14, 17, 20]
        # Restrict combinations to save time
        exclude:
          - os: macos-latest
            cxx_standard: 14
          - os: macos-latest
            cxx_standard: 17
          - os: macos-latest
            cxx_standard: 20
          - os: windows-latest
            cxx_standard: 14
          - os: windows-latest
            cxx_standard: 17
          - os: windows-latest
            cxx_standard: 20

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libssl-dev uuid-dev zlib1g-dev
        # Install dynamic libcurl for shared builds
        sudo apt-get install -y libcurl4-openssl-dev

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install openssl curl
        echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl)" >> $GITHUB_ENV

    - name: Restore vcpkg cache (Windows)
      if: runner.os == 'Windows'
      id: cache-vcpkg-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/packages
          C:/vcpkg/buildtrees
          C:/vcpkg/downloads
          ~/AppData/Local/vcpkg/archives
        # Key based on fixed dependencies: curl + openssl
        # Change this key if you modify vcpkg dependencies
        key: ${{ runner.os }}-vcpkg-curl-openssl-v1-${{ matrix.cxx_standard }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-curl-openssl-v1-
          ${{ runner.os }}-vcpkg-

    - name: Setup vcpkg binary cache (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        # Enable vcpkg binary caching to GitHub Actions cache
        export VCPKG_BINARY_SOURCES="clear;x-gha,readwrite"
        echo "VCPKG_BINARY_SOURCES=$VCPKG_BINARY_SOURCES" >> $GITHUB_ENV

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        # Use parallel build and binary caching
        export VCPKG_MAX_CONCURRENCY=$NUMBER_OF_PROCESSORS
        vcpkg install curl:x64-windows openssl:x64-windows --no-print-usage

    # Build and test both shared and static libraries in one job
    - name: Build Shared Library
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -B build-shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DCMAKE_INSTALL_PREFIX=./install-shared \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -B build-shared \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DCMAKE_INSTALL_PREFIX=./install-shared
        fi
        cmake --build build-shared --config Release

    - name: Install Shared Library
      run: cmake --install build-shared --config Release --prefix ./install-shared

    - name: Test find_package Integration (Shared)
      shell: bash
      run: |
        mkdir -p sample_test_shared
        cat > sample_test_shared/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.13)
        project(sample_test CXX)
        find_package(alibabacloud_open_api_v2 REQUIRED)
        add_executable(sample_app main.cpp)
        target_link_libraries(sample_app alibabacloud_open_api_v2::alibabacloud_open_api_v2)
        EOF
        echo '#include <alibabacloud/Openapi.hpp>
        int main() { return 0; }' > sample_test_shared/main.cpp
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -S sample_test_shared -B sample_test_shared/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-shared \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -S sample_test_shared -B sample_test_shared/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-shared \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }}
        fi
        cmake --build sample_test_shared/build --config Release

    - name: Build Static Library
      shell: bash
      run: |
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -B build-static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DCMAKE_INSTALL_PREFIX=./install-static \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -B build-static \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_STANDARD=${{ matrix.cxx_standard }} \
            -DCMAKE_INSTALL_PREFIX=./install-static
        fi
        cmake --build build-static --config Release

    - name: Install Static Library
      run: cmake --install build-static --config Release --prefix ./install-static

    - name: Test find_package Integration (Static)
      shell: bash
      run: |
        mkdir -p sample_test_static
        cat > sample_test_static/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.13)
        project(sample_test CXX)
        find_package(alibabacloud_open_api_v2 REQUIRED)
        add_executable(sample_app main.cpp)
        target_link_libraries(sample_app alibabacloud_open_api_v2::alibabacloud_open_api_v2)
        EOF
        echo '#include <alibabacloud/Openapi.hpp>
        int main() { return 0; }' > sample_test_static/main.cpp
        
        if [ "${{ runner.os }}" = "Windows" ]; then
          cmake -S sample_test_static -B sample_test_static/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-static \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake"
        else
          cmake -S sample_test_static -B sample_test_static/build \
            -DCMAKE_PREFIX_PATH=$(pwd)/install-static \
            -DOPENSSL_ROOT_DIR=${{ env.OPENSSL_ROOT_DIR }}
        fi
        cmake --build sample_test_static/build --config Release

    # Save vcpkg cache even if build/test fails
    - name: Save vcpkg cache (Windows)
      if: runner.os == 'Windows' && always()
      uses: actions/cache/save@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/packages
          C:/vcpkg/buildtrees
          C:/vcpkg/downloads
          ~/AppData/Local/vcpkg/archives
        key: ${{ runner.os }}-vcpkg-curl-openssl-v1-${{ matrix.cxx_standard }}
